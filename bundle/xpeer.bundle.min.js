!function(){var e={},n=this&&this.__awaiter||function(e,n,t,r){return new(t||(t=Promise))((function(i,o){function a(e){try{c(r.next(e))}catch(n){o(n)}}function s(e){try{c(r.throw(e))}catch(n){o(n)}}function c(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,s)}c((r=r.apply(e,n||[])).next())}))},t=this&&this.__generator||function(e,n){var t,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=n.call(e,a)}catch(s){o=[6,s],r=0}finally{t=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}};e.SignalEventManager=void 0;var r=console.log,i=function(){function e(e){this.xPeer=e,this.xPeer=e}return e.prototype.roomInfo=function(e){var n=this;if("roomInfo"===e.type){var t=e.payload,r=t.users,i=t.userInfo;this.xPeer.localPeer.nick=i.nick,this.xPeer.localPeer.id=i.id,r.forEach((function(e){n.xPeer.connectPeer(e)})),this.xPeer.emit("roomInfo",r)}},e.prototype.offer=function(e){return n(this,void 0,void 0,(function(){var n,r,i,o,a,s,c,l,d=this;return t(this,(function(t){return e.userInfo&&"offer"===e.type&&(n=e.userInfo,(i=this.xPeer.findPeer(n.id))?r=i.peerConnection:(r=new RTCPeerConnection(this.xPeer.peerConfig),o={id:n.id,nick:n.nick,peerConnection:r,media:{},dataChannel:null},r.addEventListener("datachannel",(function(e){console.log("data channel open"),o.dataChannel=e.channel,d.xPeer.emit("join",o,!0),d.xPeer.initDataChannelHandler(o)})),this.xPeer.initPeerEvents(o),this.xPeer.localPeer.Peers.push(o),a=this.xPeer.localPeer.media,s=a.user,c=a.display,l="",s&&s.getTracks().forEach((function(e){l+="[user/".concat(e.id,"]"),r.addTrack(e,s)})),c&&c.getTracks().forEach((function(e){l+="[display/".concat(e.id,"]"),r.addTrack(e,c)})),this.xPeer.localPeer.trackTags=l),this.replayAnswer(r,e)),[2]}))}))},e.prototype.replayAnswer=function(e,n){var t=this;e.setRemoteDescription(new RTCSessionDescription(n.payload)).then((function(){return e.createAnswer()})).then((function(n){return e.setLocalDescription(n)})).then((function(){var r={type:"answer",receiverId:n.userInfo.id,payload:null==e?void 0:e.localDescription};t.xPeer.signalSend(r)})).catch((function(e){throw new Error("replayAnswer error: ".concat(e))}))},e.prototype.answer=function(e){if("answer"===e.type&&e.userInfo){var n=e.userInfo,t=this.xPeer.findPeer(n.id);t&&t.peerConnection.setRemoteDescription(new RTCSessionDescription(e.payload))}},e.prototype.icecandidate=function(e){if("icecandidate"===e.type&&e.userInfo){var n=e.userInfo,t=this.xPeer.findPeer(n.id);t&&t.peerConnection.addIceCandidate(new RTCIceCandidate(e.payload))}},e.prototype.leave=function(e){if("leave"===e.type){var n=this.xPeer.findPeer(e.payload.id);n&&(n.peerConnection.close(),this.xPeer.localPeer.Peers=this.xPeer.localPeer.Peers.filter((function(e){return e!==n}))),this.xPeer.emit("leave",e.payload)}},e.prototype.join=function(e){},e.prototype.handle=function(){var e=this;if(window.xPeer=this.xPeer,!this.xPeer.ws)throw new Error("ws is not defined when handling signal event");this.xPeer.ws.addEventListener("message",(function(n){var t=n.data,i=JSON.parse(t);r("received [".concat(i.type,"]"),i),e[i.type](i)}));var n=setInterval(this.keepAlive,59e3);this.xPeer.ws.addEventListener("close",(function(){return clearInterval(n)}))},e.prototype.keepAlive=function(){this.xPeer.signalSend({type:"ping"})},e}();e.SignalEventManager=i;var o={exports:{}},a=Object.prototype.hasOwnProperty,s="~";function c(){}function l(e,n,t){this.fn=e,this.context=n,this.once=t||!1}function d(e,n,t,r,i){if("function"!=typeof t)throw new TypeError("The listener must be a function");var o=new l(t,r||e,i),a=s?s+n:n;return e._events[a]?e._events[a].fn?e._events[a]=[e._events[a],o]:e._events[a].push(o):(e._events[a]=o,e._eventsCount++),e}function u(e,n){0==--e._eventsCount?e._events=new c:delete e._events[n]}function f(){this._events=new c,this._eventsCount=0}Object.create&&(c.prototype=Object.create(null),(new c).__proto__||(s=!1)),f.prototype.eventNames=function(){var e,n,t=[];if(0===this._eventsCount)return t;for(n in e=this._events)a.call(e,n)&&t.push(s?n.slice(1):n);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t},f.prototype.listeners=function(e){var n=s?s+e:e,t=this._events[n];if(!t)return[];if(t.fn)return[t.fn];for(var r=0,i=t.length,o=new Array(i);r<i;r++)o[r]=t[r].fn;return o},f.prototype.listenerCount=function(e){var n=s?s+e:e,t=this._events[n];return t?t.fn?1:t.length:0},f.prototype.emit=function(e,n,t,r,i,o){var a=s?s+e:e;if(!this._events[a])return!1;var c,l,d=this._events[a],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,n),!0;case 3:return d.fn.call(d.context,n,t),!0;case 4:return d.fn.call(d.context,n,t,r),!0;case 5:return d.fn.call(d.context,n,t,r,i),!0;case 6:return d.fn.call(d.context,n,t,r,i,o),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];d.fn.apply(d.context,c)}else{var f,p=d.length;for(l=0;l<p;l++)switch(d[l].once&&this.removeListener(e,d[l].fn,void 0,!0),u){case 1:d[l].fn.call(d[l].context);break;case 2:d[l].fn.call(d[l].context,n);break;case 3:d[l].fn.call(d[l].context,n,t);break;case 4:d[l].fn.call(d[l].context,n,t,r);break;default:if(!c)for(f=1,c=new Array(u-1);f<u;f++)c[f-1]=arguments[f];d[l].fn.apply(d[l].context,c)}}return!0},f.prototype.on=function(e,n,t){return d(this,e,n,t,!1)},f.prototype.once=function(e,n,t){return d(this,e,n,t,!0)},f.prototype.removeListener=function(e,n,t,r){var i=s?s+e:e;if(!this._events[i])return this;if(!n)return u(this,i),this;var o=this._events[i];if(o.fn)o.fn!==n||r&&!o.once||t&&o.context!==t||u(this,i);else{for(var a=0,c=[],l=o.length;a<l;a++)(o[a].fn!==n||r&&!o[a].once||t&&o[a].context!==t)&&c.push(o[a]);c.length?this._events[i]=1===c.length?c[0]:c:u(this,i)}return this},f.prototype.removeAllListeners=function(e){var n;return e?(n=s?s+e:e,this._events[n]&&u(this,n)):(this._events=new c,this._eventsCount=0),this},f.prototype.off=f.prototype.removeListener,f.prototype.addListener=f.prototype.on,f.prefixed=s,f.EventEmitter=f,o.exports=f,o=o.exports;var p={},h=this&&this.__awaiter||function(e,n,t,r){return new(t||(t=Promise))((function(i,o){function a(e){try{c(r.next(e))}catch(n){o(n)}}function s(e){try{c(r.throw(e))}catch(n){o(n)}}function c(e){var n;e.done?i(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,s)}c((r=r.apply(e,n||[])).next())}))},v=this&&this.__generator||function(e,n){var t,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=n.call(e,a)}catch(s){o=[6,s],r=0}finally{t=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}};p.__esModule=!0,p.EE=void 0,p.EE=new o;var y=console.log,w=function(){function n(e){var n=e.signalServer,t=e.peerConfig;this.localPeer={id:"",nick:"",Peers:[],media:{}},this.signalServer=n,this.peerConfig=t}return n.prototype.initWebsocketEvent=function(){var n=this;return this.ws=new WebSocket(this.signalServer),new Promise((function(t,r){n.ws&&(n.ws.addEventListener("open",(function(){p.EE.emit("signal:open"),new e.SignalEventManager(n).handle(),t(n.ws)})),n.ws.addEventListener("error",(function(){p.EE.emit("signal:error"),r("ws error in initWebsocketEvent")})),n.ws.addEventListener("close",(function(){p.EE.emit("signal:close"),r("ws close in initWebsocketEvent")})))}))},n.prototype.join=function(e){var n=e.roomId,t=e.nick;return h(this,void 0,void 0,(function(){var e,r;return v(this,(function(i){switch(i.label){case 0:return this.ws&&this.ws.readyState!==WebSocket.CLOSED?[3,2]:[4,this.initWebsocketEvent()];case 1:i.sent(),i.label=2;case 2:return e=this.localPeer,t&&(e.nick=t),r={type:"join",receiverId:null,payload:{roomId:n,nick:e.nick}},this.signalSend(r),[2,e]}}))}))},n.prototype.initTrackHandler=function(e){return function(n){y("PC:[track] \u4e3b\u52a8\u8005\u6536",n);var t=n.track,r=n.target.remoteDescription.sdp.toString(),i=function(){e.media.user||(e.media.user=new MediaStream,p.EE.emit("stream:user",e)),e.media.user.addTrack(t)},o=function(){e.media.display||(e.media.display=new MediaStream,p.EE.emit("stream:display",e)),e.media.display.addTrack(t)};-1!==r.indexOf("[user/".concat(t.id,"]"))?i():-1!==r.indexOf("[display/".concat(t.id,"]"))?o():-1!==r.indexOf("[user/")?i():-1!==r.indexOf("[display/")&&o()}},n.prototype.initIceCandidateHandler=function(e){var n=this;return function(t){y("PC:[icecandidate]",t),t.candidate&&n.signalSend({type:"icecandidate",receiverId:e.id,payload:t.candidate})}},n.prototype.connectPeer=function(e){var n=this;y("connectPeer",e);var t=new RTCPeerConnection(this.peerConfig),r=t.createDataChannel("dc");y("\u6dfb\u52a0datachannel",{pc:t});var i={id:e.id,nick:e.nick,peerConnection:t,media:{},dataChannel:null};r.addEventListener("open",(function(e){y("dc open",e),i.dataChannel=r,n.emit("join",i,!1),n.initDataChannelHandler(i)})),this.initPeerEvents(i),this.addPeer(i)},n.prototype.initPeerEvents=function(e){var n=e.peerConnection;n.addEventListener("icecandidate",this.initIceCandidateHandler(e)),n.addEventListener("track",this.initTrackHandler(e)),n.addEventListener("negotiationneeded",this.initNegotiationHandler(e))},n.prototype.initNegotiationHandler=function(e){var n=this,t=e.peerConnection;return function(){y("PC:[negotiationneeded]",t),t.createOffer().then((function(e){return e.sdp=function(e,n){void 0===e&&(e=""),void 0===n&&(n=""),console.log("addCustomLabelToSdp",{sdp:e,str:n});for(var t=e.split("\n"),r=0;r<t.length;r++){var i=t[r];i=i.replace(/(a=extmap:[0-9]+) [^ \n]+/gi,"$1 ".concat(n)),t[r]=i}return t.join("\n")}(e.sdp,n.localPeer.trackTags),t.setLocalDescription(e)})).then((function(){p.EE.emit("negotiationneeded:done",e),t.localDescription&&n.signalSend({type:"offer",receiverId:e.id,payload:t.localDescription})}))}},n.prototype.initDataChannelHandler=function(e){e.dataChannel&&(e.dataChannel.onmessage=function(n){if("string"==typeof n.data){var t=JSON.parse(n.data).payload;console.log("datachannel:\u6536\u5230\u6d88\u606f",n),"streamStop:display"===t?(delete e.media.display,p.EE.emit("streamStop:display",e)):p.EE.emit("message",e,t)}else console.log("datachannel:\u6536\u5230\u4e8c\u8fdb\u5236\u6d88\u606f",n),p.EE.emit("binary",e,n.data)},e.dataChannel.onclose=function(e){console.log("datachannel:\u65ad\u5f00\u8fde\u63a5",e)})},n.prototype.addPeer=function(e){this.localPeer.Peers.push(e)},n.prototype.findPeer=function(e){return this.localPeer.Peers.find((function(n){return n.id===e}))},n.prototype.signalSend=function(e){var n=this;this.onSignalServerReady((function(){var t;null===(t=n.ws)||void 0===t||t.send(JSON.stringify(e))}))},n.prototype.shareUser=function(e){void 0===e&&(e={});var n=this.localPeer;return navigator.mediaDevices.getUserMedia(e).then((function(e){n.media.user=e;var t=e.getTracks(),r=t.map((function(e){return"[user/".concat(e.id,"]")})).join("");return n.trackTags=r,n.Peers.forEach((function(n){t.forEach((function(t){y("\u6dfb\u52a0track\u5230peer\u4e2d",{peer:n,track:t}),n.peerConnection.addTrack(t,e)}))})),n})).catch((function(e){throw new Error("unable to get user media: ".concat(e.message))}))},n.prototype.shareDisplay=function(e){var n=this;void 0===e&&(e={});var t=this.localPeer;return navigator.mediaDevices.getDisplayMedia(e).then((function(e){t.media.display=e;var r=e.getTracks(),i=r.map((function(e){return"[display/".concat(e.id,"]")})).join("");return t.trackTags=i,t.Peers.forEach((function(n){r.forEach((function(t){n.peerConnection.addTrack(t,e)}))})),t.media.display.addEventListener("inactive",n.onStopDisplay.bind(n)),t})).catch((function(e){throw new Error("unable to get user media: ".concat(e.message))}))},n.prototype.onStopDisplay=function(){this.send("streamStop:display"),delete this.localPeer.media.display},n.prototype.onSignalServerReady=function(e){if(!this.ws)throw new Error("signal server not ready");this.ws.readyState===WebSocket.OPEN?e():this.ws.readyState===WebSocket.CONNECTING?this.ws.addEventListener("open",(function(){e()})):this.ws.readyState===WebSocket.CLOSED&&this.initWebsocketEvent().then(e)},n.prototype.leave=function(){var e,n,t;null===(e=this.localPeer.media.user)||void 0===e||e.getTracks().forEach((function(e){return e.stop()})),null===(n=this.localPeer.media.display)||void 0===n||n.getTracks().forEach((function(e){return e.stop()})),delete this.localPeer.media.user,delete this.localPeer.media.display,this.localPeer.Peers.forEach((function(e){var n;e.peerConnection.close(),null===(n=e.dataChannel)||void 0===n||n.close()})),this.localPeer.Peers=[],null===(t=this.ws)||void 0===t||t.close(),delete this.ws},n.prototype.on=function(e,n){p.EE.on(e,n,this)},n.prototype.emit=function(e,n,t){void 0===t&&(t=!0),p.EE.emit(e,n,t)},n.prototype.setMute=function(e,n){return this.localPeer.media.user?(this.localPeer.media.user.getTracks().forEach((function(t){t.kind===e&&(t.enabled=n)})),Promise.resolve()):Promise.reject(new Error("no user media"))},n.prototype.sendBinary=function(e){this.localPeer.Peers.forEach((function(n){var t;null===(t=n.dataChannel)||void 0===t||t.send(e)}))},n.prototype.send=function(e){var n={id:this.localPeer.id,nick:this.localPeer.nick};this.localPeer.Peers.forEach((function(t){var r=t.dataChannel;null==r||r.send(JSON.stringify({userInfo:n,payload:e}))}))},n}();p.default=w,window.XPeer=w}();
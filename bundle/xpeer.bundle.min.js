!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).XPeer=e()}}((function(){var e=function(e){var t;return function(n){return t||e(t={exports:{},parent:n},t.exports),t.exports}},t=e((function(e,t){"use strict";var o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{c(r.next(e))}catch(t){o(t)}}function s(e){try{c(r.throw(e))}catch(t){o(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};t.log=void 0;var c=n({}),l=s(r({}));t.log=console.log;var u={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},f=function(){function e(e){var t=e.signalServer,n=e.peerConfig;this.eventBus=new i,this.local={id:"",nick:"",Peers:[],media:{}},this.signalServer=t,this.peerConfig=n||u}return e.prototype.initWebsocketEvent=function(){var e=this;return this.ws=new WebSocket(this.signalServer),new Promise((function(t,n){e.ws&&(e.ws.addEventListener("open",(function(){e.emit("signal:open"),new c.SignalEventManager(e).handle(),t(e.ws)})),e.ws.addEventListener("error",(function(){e.emit("signal:error"),n("ws error in initWebsocketEvent")})),e.ws.addEventListener("close",(function(){e.emit("signal:close"),n("ws close in initWebsocketEvent")})))}))},e.prototype.join=function(e){var t=e.roomId,n=e.nick;return o(this,void 0,void 0,(function(){var e,r;return a(this,(function(i){switch(i.label){case 0:return this.ws&&this.ws.readyState!==WebSocket.CLOSED?[3,2]:[4,this.initWebsocketEvent()];case 1:i.sent(),i.label=2;case 2:return e=this.local,n&&(e.nick=n),r={type:"join",receiverId:null,payload:{roomId:t,nick:e.nick}},this.signalSend(r),[2,e]}}))}))},e.prototype.connectPeer=function(e){var t=new l.default(e.id,e.nick,new RTCPeerConnection(this.peerConfig),this);this.addPeer(t),t.connect()},e.prototype.addPeer=function(e){this.local.Peers.push(e)},e.prototype.findPeer=function(e){return this.local.Peers.find((function(t){return t.id===e}))},e.prototype.signalSend=function(e){var t=this;this.onSignalServerReady((function(){var n;null===(n=t.ws)||void 0===n||n.send(JSON.stringify(e))}))},e.prototype.shareUser=function(e){void 0===e&&(e={});var n=this.local;return navigator.mediaDevices.getUserMedia(e).then((function(e){n.media.user=e;var r=e.getTracks(),i=r.map((function(e){return"[user/".concat(e.id,"]")})).join("");return n.trackTags=i,n.Peers.forEach((function(n){r.forEach((function(r){(0,t.log)("\u6dfb\u52a0track\u5230peer\u4e2d",{peer:n,track:r}),n.peerConnection.addTrack(r,e)}))})),n})).catch((function(e){throw new Error("unable to get user media: ".concat(e.message))}))},e.prototype.shareDisplay=function(e){var t=this;void 0===e&&(e={});var n=this.local;return navigator.mediaDevices.getDisplayMedia(e).then((function(e){n.media.display=e;var r=e.getTracks(),i=r.map((function(e){return"[display/".concat(e.id,"]")})).join("");return n.trackTags=i,n.Peers.forEach((function(t){r.forEach((function(n){t.peerConnection.addTrack(n,e)}))})),n.media.display.addEventListener("inactive",t.onStopDisplay.bind(t)),n})).catch((function(e){throw new Error("unable to get user media: ".concat(e.message))}))},e.prototype.pushLocalStreamTo=function(e){var t=this.local.media,n=t.user,r=t.display,i=e.peerConnection,o="";n&&n.getTracks().forEach((function(e){o+="[user/".concat(e.id,"]"),i.addTrack(e,n)})),r&&r.getTracks().forEach((function(e){o+="[display/".concat(e.id,"]"),i.addTrack(e,r)})),this.local.trackTags=o},e.prototype.onStopDisplay=function(){this.send("streamStop:display"),delete this.local.media.display},e.prototype.onSignalServerReady=function(e){if(!this.ws)throw new Error("signal server not ready");this.ws.readyState===WebSocket.OPEN?e():this.ws.readyState===WebSocket.CONNECTING?this.ws.addEventListener("open",(function(){e()})):this.ws.readyState===WebSocket.CLOSED&&this.initWebsocketEvent().then(e)},e.prototype.leave=function(){var e,t,n;null===(e=this.local.media.user)||void 0===e||e.getTracks().forEach((function(e){return e.stop()})),null===(t=this.local.media.display)||void 0===t||t.getTracks().forEach((function(e){return e.stop()})),delete this.local.media.user,delete this.local.media.display,this.local.Peers.forEach((function(e){var t;e.peerConnection.close(),null===(t=e.dataChannel)||void 0===t||t.close()})),this.local.Peers=[],null===(n=this.ws)||void 0===n||n.close(),delete this.ws,this.eventBus.removeAllListeners()},e.prototype.on=function(e,t){this.eventBus.on(e,t,this)},e.prototype.emit=function(e,t){this.eventBus.emit(e,t)},e.prototype.setMute=function(e,t){return this.local.media.user?(this.local.media.user.getTracks().forEach((function(n){n.kind===e&&(n.enabled=t)})),Promise.resolve()):Promise.reject(new Error("no user media"))},e.prototype.sendBinary=function(e){this.local.Peers.forEach((function(t){var n;null===(n=t.dataChannel)||void 0===n||n.send(e)}))},e.prototype.send=function(e){var t={id:this.local.id,nick:this.local.nick};this.local.Peers.forEach((function(n){var r=n.dataChannel;null==r||r.send(JSON.stringify({userInfo:t,payload:e}))}))},e}();t.default=f})),n=e((function(e,t){"use strict";var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{c(r.next(e))}catch(t){o(t)}}function s(e){try{c(r.throw(e))}catch(t){o(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};t.SignalEventManager=void 0;var a=o(r({})),s=console.log,c=function(){function e(e){this.xPeer=e,this.xPeer=e}return e.prototype.roomInfo=function(e){var t=this;if("roomInfo"===e.type){var n=e.payload,r=n.users,i=n.userInfo;this.xPeer.local.nick=i.nick,this.xPeer.local.id=i.id,r.forEach((function(e){t.xPeer.connectPeer(e)})),this.xPeer.emit("roomInfo",r)}},e.prototype.offer=function(e){return n(this,void 0,void 0,(function(){var t,n,r,o;return i(this,(function(i){return e.userInfo&&"offer"===e.type&&(t=e.userInfo,n=t.id,r=t.nick,(o=this.xPeer.findPeer(n))||(o=new a.default(n,r,new RTCPeerConnection(this.xPeer.peerConfig),this.xPeer),this.xPeer.addPeer(o),this.xPeer.pushLocalStreamTo(o)),o.receiveOffer(e)),[2]}))}))},e.prototype.answer=function(e){if("answer"===e.type&&e.userInfo){var t=e.userInfo,n=this.xPeer.findPeer(t.id);null==n||n.receiveAnswer(e.payload)}},e.prototype.icecandidate=function(e){if("icecandidate"===e.type&&e.userInfo){var t=e.userInfo,n=this.xPeer.findPeer(t.id);null==n||n.receiveCandidate(e.payload)}},e.prototype.leave=function(e){if("leave"===e.type){var t=this.xPeer.findPeer(e.payload.id);t&&(t.peerConnection.close(),this.xPeer.local.Peers=this.xPeer.local.Peers.filter((function(e){return e!==t}))),this.xPeer.emit("leave",e.payload)}},e.prototype.join=function(e){},e.prototype.handle=function(){var e=this,t=this;if(!this.xPeer.ws)throw new Error("ws is not defined when handling signal event");this.xPeer.ws.addEventListener("message",(function(e){var n=e.data,r=JSON.parse(n);s("received [".concat(r.type,"]"),r),t[r.type](r)}));var n=setInterval((function(){e.keepAlive()}),59e3);this.xPeer.ws.addEventListener("close",(function(){return clearInterval(n)}))},e.prototype.keepAlive=function(){this.xPeer.signalSend({type:"ping"})},e}();t.SignalEventManager=c})),r=e((function(e,n){"use strict";n.__esModule=!0;var r=t({}),i=function(){function e(e,t,n,r){this.id=e,this.nick=t,this.peerConnection=n,this.parentInstance=r,this.isConnected=!1,this.media={},this.dataChannel=null,this.id=e,this.nick=t,this.peerConnection=n,this.parentInstance=r,this.initPeerConnectionEvents()}return e.prototype.connect=function(){var e=this;if(this.isConnected)return Promise.reject(new Error("peer already connected"));var t=this.peerConnection;return new Promise((function(n,i){var o=t.createDataChannel("dc");e.initDataChannelEvents(o),o.addEventListener("open",(function(){(0,r.log)("datachannel \u6253\u5f00\u4e86\uff01"),n(e),e.dataChannel=o,e.isConnected=!0,e.parentInstance.emit("connected",e)})),setTimeout((function(){i(new Error("connect timeout"))}),1e4)}))},e.prototype.receiveOffer=function(e){var t=this;"offer"===e.type&&this.peerConnection.setRemoteDescription(new RTCSessionDescription(e.payload)).then((function(){return t.replyAnswer(e)}))},e.prototype.receiveAnswer=function(e){this.peerConnection.setRemoteDescription(new RTCSessionDescription(e))},e.prototype.receiveCandidate=function(e){(0,r.log)("\u6536\u5230icecandidate\uff0c\u5e76\u6dfb\u52a0\u5230\u672c\u5730"),this.peerConnection.addIceCandidate(new RTCIceCandidate(e))},e.prototype.replyAnswer=function(e){var t=this,n=this.peerConnection;"offer"===e.type&&n.createAnswer().then((function(e){return n.setLocalDescription(e)})).then((function(){var r,i={type:"answer",receiverId:e.userInfo.id,payload:null===(r=n.localDescription)||void 0===r?void 0:r.toJSON()};t.parentInstance.signalSend(i)})).catch((function(e){throw new Error("replayAnswer error: ".concat(e))}))},e.prototype.initDataChannelEvents=function(e){var t=this;e.onmessage=function(e){if("string"==typeof e.data){var n=JSON.parse(e.data).payload;"streamStop:display"===n?(delete t.media.display,t.parentInstance.emit("streamStop:display",t)):t.parentInstance.emit("message",{peer:t,payload:n})}else t.parentInstance.emit("binary",{peer:t,payload:e.data})},e.onclose=function(){}},e.prototype.initPeerConnectionEvents=function(){var e=this,t=this,n=t.peerConnection;n.oniceconnectionstatechange=function(){return console.log("ICESTATE_CHANGE",n.iceConnectionState)},n.addEventListener("icecandidate",(function(n){(0,r.log)("PC:[icecandidate]",n),n.candidate&&e.parentInstance.signalSend({type:"icecandidate",receiverId:t.id,payload:n.candidate})})),n.addEventListener("track",(function(n){(0,r.log)("PC:[track] \u4e3b\u52a8\u8005\u6536",n);var i,o,a=n.streams[0],s=(i=n.target.remoteDescription.sdp.toString(),o=n.track,-1!==i.indexOf("[user/".concat(o.id,"]"))?"user":-1!==i.indexOf("[display/".concat(o.id,"]"))?"display":-1!==i.indexOf("[user/")?"user":-1!==i.indexOf("[display/")?"display":"unknown");"user"===s?t.media.user&&t.media.user.id===a.id||(t.media.user=a,e.parentInstance.emit("stream:user",t)):"display"===s&&(t.media.display&&t.media.display.id===a.id||(t.media.display=a,e.parentInstance.emit("stream:display",t)))})),n.addEventListener("negotiationneeded",(function(){var t=e.peerConnection;t.createOffer().then((function(n){return n.sdp=function(e,t){void 0===e&&(e=""),void 0===t&&(t=""),console.log("addCustomLabelToSdp",{sdp:e,str:t});for(var n=e.split("\n"),r=0;r<n.length;r++){var i=n[r];i=i.replace(/(a=extmap:[0-9]+) [^ \n]+/gi,"$1 ".concat(t)),n[r]=i}return n.join("\n")}(n.sdp,e.parentInstance.local.trackTags),t.setLocalDescription(n).then((function(){return n}))})).then((function(t){e.parentInstance.emit("negotiationneeded:done",e),e.parentInstance.signalSend({type:"offer",receiverId:e.id,payload:t})}))})),n.addEventListener("datachannel",(function(t){var n=t.channel;e.dataChannel=n,e.isConnected=!0,e.parentInstance.emit("join",e)}))},e}();n.default=i})),i={exports:{}},o=Object.prototype.hasOwnProperty,a="~";function s(){}function c(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function l(e,t,n,r,i){if("function"!=typeof n)throw new TypeError("The listener must be a function");var o=new c(n,r||e,i),s=a?a+t:t;return e._events[s]?e._events[s].fn?e._events[s]=[e._events[s],o]:e._events[s].push(o):(e._events[s]=o,e._eventsCount++),e}function u(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function f(){this._events=new s,this._eventsCount=0}return Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(a=!1)),f.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)o.call(e,t)&&n.push(a?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},f.prototype.listeners=function(e){var t=a?a+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var r=0,i=n.length,o=new Array(i);r<i;r++)o[r]=n[r].fn;return o},f.prototype.listenerCount=function(e){var t=a?a+e:e,n=this._events[t];return n?n.fn?1:n.length:0},f.prototype.emit=function(e,t,n,r,i,o){var s=a?a+e:e;if(!this._events[s])return!1;var c,l,u=this._events[s],f=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),f){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,r),!0;case 5:return u.fn.call(u.context,t,n,r,i),!0;case 6:return u.fn.call(u.context,t,n,r,i,o),!0}for(l=1,c=new Array(f-1);l<f;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var d,p=u.length;for(l=0;l<p;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),f){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,n);break;case 4:u[l].fn.call(u[l].context,t,n,r);break;default:if(!c)for(d=1,c=new Array(f-1);d<f;d++)c[d-1]=arguments[d];u[l].fn.apply(u[l].context,c)}}return!0},f.prototype.on=function(e,t,n){return l(this,e,t,n,!1)},f.prototype.once=function(e,t,n){return l(this,e,t,n,!0)},f.prototype.removeListener=function(e,t,n,r){var i=a?a+e:e;if(!this._events[i])return this;if(!t)return u(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||r&&!o.once||n&&o.context!==n||u(this,i);else{for(var s=0,c=[],l=o.length;s<l;s++)(o[s].fn!==t||r&&!o[s].once||n&&o[s].context!==n)&&c.push(o[s]);c.length?this._events[i]=1===c.length?c[0]:c:u(this,i)}return this},f.prototype.removeAllListeners=function(e){var t;return e?(t=a?a+e:e,this._events[t]&&u(this,t)):(this._events=new s,this._eventsCount=0),this},f.prototype.off=f.prototype.removeListener,f.prototype.addListener=f.prototype.on,f.prefixed=a,f.EventEmitter=f,i.exports=f,i=i.exports,t({}).default}));
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).XPeer=e()}}((function(){return function r(e,t,n){function o(a,s){if(!t[a]){if(!e[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(i)return i(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var u=t[a]={exports:{}};e[a][0].call(u.exports,(function(t){return o(e[a][1][t]||t)}),u,u.exports,r,e,t,n)}return t[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(e,t,n){t.exports=e("./").default},{"./":2}],2:[function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function fulfilled(e){try{step(i.next(e))}catch(e){s(e)}}function rejected(e){try{step(i.throw(e))}catch(e){s(e)}}function step(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var n,i,a,s,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function verb(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;c;)try{if(n=1,i&&(a=2&s[0]?i.return:s[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,s[1])).done)return a;switch(i=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return c.label++,{value:s[1],done:!1};case 5:c.label++,i=s[1],s=[0];continue;case 7:s=c.ops.pop(),c.trys.pop();continue;default:if(!(a=c.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){c=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){c.label=s[1];break}if(6===s[0]&&c.label<a[1]){c.label=a[1],a=s;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(s);break}a[2]&&c.ops.pop(),c.trys.pop();continue}s=t.call(e,c)}catch(e){s=[6,e],i=0}finally{n=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};n.__esModule=!0,n.log=void 0;var c=e("./signalEventManager"),l=e("eventemitter3"),u=s(e("./peer"));n.log=console.log;var f={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},d=function(){function XPeer(e){var t=e.signalServer,n=e.peerConfig;this.eventBus=new l,this.local={id:"",nick:"",Peers:[],media:{}},this.signalServer=t,this.peerConfig=n||f}return XPeer.prototype.initWebsocketEvent=function(){var e=this;return this.ws=new WebSocket(this.signalServer),new Promise((function(t,n){e.ws&&(e.ws.addEventListener("open",(function(){e.emit("signal:open"),new c.SignalEventManager(e).handle(),t(e.ws)})),e.ws.addEventListener("error",(function(){e.emit("signal:error"),n("ws error in initWebsocketEvent")})),e.ws.addEventListener("close",(function(){e.emit("signal:close"),n("ws close in initWebsocketEvent")})))}))},XPeer.prototype.join=function(e){var t=e.roomId,n=e.nick;return i(this,void 0,void 0,(function(){var e,i;return a(this,(function(a){switch(a.label){case 0:return this.ws&&this.ws.readyState!==WebSocket.CLOSED?[3,2]:[4,this.initWebsocketEvent()];case 1:a.sent(),a.label=2;case 2:return e=this.local,n&&(e.nick=n),i={type:"join",receiverId:null,payload:{roomId:t,nick:e.nick}},this.signalSend(i),[2,e]}}))}))},XPeer.prototype.connectPeer=function(e){var t=new u.default(e.id,e.nick,new RTCPeerConnection(this.peerConfig),this);this.addPeer(t),t.connect()},XPeer.prototype.addPeer=function(e){this.local.Peers.push(e)},XPeer.prototype.findPeer=function(e){return this.local.Peers.find((function(t){return t.id===e}))},XPeer.prototype.signalSend=function(e){var t=this;this.onSignalServerReady((function(){var n;null===(n=t.ws)||void 0===n||n.send(JSON.stringify(e))}))},XPeer.prototype.shareUser=function(e){void 0===e&&(e={});var t=this.local;return navigator.mediaDevices.getUserMedia(e).then((function(e){t.media.user=e;var i=e.getTracks(),a=i.map((function(e){return"[user/".concat(e.id,"]")})).join("");return t.trackTags=a,t.Peers.forEach((function(t){i.forEach((function(i){(0,n.log)("添加track到peer中",{peer:t,track:i}),t.peerConnection.addTrack(i,e)}))})),t})).catch((function(e){throw new Error("unable to get user media: ".concat(e.message))}))},XPeer.prototype.shareDisplay=function(e){var t=this;void 0===e&&(e={});var n=this.local;return navigator.mediaDevices.getDisplayMedia(e).then((function(e){n.media.display=e;var i=e.getTracks(),a=i.map((function(e){return"[display/".concat(e.id,"]")})).join("");return n.trackTags=a,n.Peers.forEach((function(t){i.forEach((function(n){t.peerConnection.addTrack(n,e)}))})),n.media.display.addEventListener("inactive",t.onStopDisplay.bind(t)),n})).catch((function(e){throw new Error("unable to get user media: ".concat(e.message))}))},XPeer.prototype.pushLocalStreamTo=function(e){var t=this.local.media,n=t.user,i=t.display,a=e.peerConnection,s="";n&&n.getTracks().forEach((function(e){s+="[user/".concat(e.id,"]"),a.addTrack(e,n)})),i&&i.getTracks().forEach((function(e){s+="[display/".concat(e.id,"]"),a.addTrack(e,i)})),this.local.trackTags=s},XPeer.prototype.onStopDisplay=function(){this.send("streamStop:display"),delete this.local.media.display},XPeer.prototype.onSignalServerReady=function(e){if(!this.ws)throw new Error("signal server not ready");this.ws.readyState===WebSocket.OPEN?e():this.ws.readyState===WebSocket.CONNECTING?this.ws.addEventListener("open",(function(){e()})):this.ws.readyState===WebSocket.CLOSED&&this.initWebsocketEvent().then(e)},XPeer.prototype.leave=function(){var e,t,n;null===(e=this.local.media.user)||void 0===e||e.getTracks().forEach((function(e){return e.stop()})),null===(t=this.local.media.display)||void 0===t||t.getTracks().forEach((function(e){return e.stop()})),delete this.local.media.user,delete this.local.media.display,this.local.Peers.forEach((function(e){var t;e.peerConnection.close(),null===(t=e.dataChannel)||void 0===t||t.close()})),this.local.Peers=[],null===(n=this.ws)||void 0===n||n.close(),delete this.ws,this.eventBus.removeAllListeners()},XPeer.prototype.on=function(e,t){this.eventBus.on(e,t,this)},XPeer.prototype.emit=function(e,t){this.eventBus.emit(e,t)},XPeer.prototype.setMute=function(e,t){return this.local.media.user?(this.local.media.user.getTracks().forEach((function(n){n.kind===e&&(n.enabled=t)})),Promise.resolve()):Promise.reject(new Error("no user media"))},XPeer.prototype.sendBinary=function(e){this.local.Peers.forEach((function(t){var n;null===(n=t.dataChannel)||void 0===n||n.send(e)}))},XPeer.prototype.send=function(e){var t={id:this.local.id,nick:this.local.nick};this.local.Peers.forEach((function(n){var i=n.dataChannel;null==i||i.send(JSON.stringify({userInfo:t,payload:e}))}))},XPeer}();n.default=d},{"./peer":3,"./signalEventManager":4,eventemitter3:5}],3:[function(e,t,n){"use strict";n.__esModule=!0;var i=e("."),a=function(){function Peer(e,t,n,i){this.id=e,this.nick=t,this.peerConnection=n,this.parentInstance=i,this.isConnected=!1,this.media={},this.dataChannel=null,this.id=e,this.nick=t,this.peerConnection=n,this.parentInstance=i,this.initPeerConnectionEvents()}return Peer.prototype.connect=function(){var e=this;if(this.isConnected)return Promise.reject(new Error("peer already connected"));var t=this.peerConnection;return new Promise((function(n,a){var s=t.createDataChannel("dc");e.initDataChannelEvents(s),s.addEventListener("open",(function(){(0,i.log)("datachannel 打开了！"),n(e),e.dataChannel=s,e.isConnected=!0,e.parentInstance.emit("connect",e)})),setTimeout((function(){a(new Error("connect timeout"))}),1e4)}))},Peer.prototype.receiveOffer=function(e){var t=this;"offer"===e.type&&this.peerConnection.setRemoteDescription(new RTCSessionDescription(e.payload)).then((function(){return t.replyAnswer(e)}))},Peer.prototype.receiveAnswer=function(e){this.peerConnection.setRemoteDescription(new RTCSessionDescription(e))},Peer.prototype.receiveCandidate=function(e){(0,i.log)("收到icecandidate，并添加到本地"),this.peerConnection.addIceCandidate(new RTCIceCandidate(e))},Peer.prototype.replyAnswer=function(e){var t=this,n=this.peerConnection;"offer"===e.type&&n.createAnswer().then((function(e){return n.setLocalDescription(e)})).then((function(){var i,a={type:"answer",receiverId:e.userInfo.id,payload:null===(i=n.localDescription)||void 0===i?void 0:i.toJSON()};t.parentInstance.signalSend(a)})).catch((function(e){throw new Error("replayAnswer error: ".concat(e))}))},Peer.prototype.initDataChannelEvents=function(e){var t=this;e.onmessage=function(e){if("string"==typeof e.data){var n=JSON.parse(e.data).payload;"streamStop:display"===n?(delete t.media.display,t.parentInstance.emit("streamStop:display",t)):t.parentInstance.emit("message",{peer:t,payload:n})}else t.parentInstance.emit("binary",{peer:t,payload:e.data})},e.onclose=function(){}},Peer.prototype.initPeerConnectionEvents=function(){var e=this,t=this,n=t.peerConnection;n.oniceconnectionstatechange=function(){return console.log("ICESTATE_CHANGE",n.iceConnectionState)},n.addEventListener("icecandidate",(function(n){(0,i.log)("PC:[icecandidate]",n),n.candidate&&e.parentInstance.signalSend({type:"icecandidate",receiverId:t.id,payload:n.candidate})})),n.addEventListener("track",(function(n){(0,i.log)("PC:[track] 主动者收",n);var a=n.streams[0],s=function(e,t){if(-1!==e.indexOf("[user/".concat(t.id,"]")))return"user";if(-1!==e.indexOf("[display/".concat(t.id,"]")))return"display";if(-1!==e.indexOf("[user/"))return"user";if(-1!==e.indexOf("[display/"))return"display";return"unknown"}(n.target.remoteDescription.sdp.toString(),n.track);"user"===s?t.media.user&&t.media.user.id===a.id||(t.media.user=a,e.parentInstance.emit("stream:user",t)):"display"===s&&(t.media.display&&t.media.display.id===a.id||(t.media.display=a,e.parentInstance.emit("stream:display",t)))})),n.addEventListener("negotiationneeded",(function(){var t=e.peerConnection;t.createOffer().then((function(n){return n.sdp=function(e,t){void 0===e&&(e="");void 0===t&&(t="");console.log("addCustomLabelToSdp",{sdp:e,str:t});for(var n=e.split("\n"),i=0;i<n.length;i++){var a=n[i];a=a.replace(/(a=extmap:[0-9]+) [^ \n]+/gi,"$1 ".concat(t)),n[i]=a}return n.join("\n")}(n.sdp,e.parentInstance.local.trackTags),t.setLocalDescription(n).then((function(){return n}))})).then((function(t){e.parentInstance.emit("negotiationneeded:done",e),e.parentInstance.signalSend({type:"offer",receiverId:e.id,payload:t})}))})),n.addEventListener("datachannel",(function(t){var n=t.channel;e.dataChannel=n,e.isConnected=!0,e.parentInstance.emit("join",e)}))},Peer}();n.default=a},{".":2}],4:[function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function fulfilled(e){try{step(i.next(e))}catch(e){s(e)}}function rejected(e){try{step(i.throw(e))}catch(e){s(e)}}function step(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var n,i,a,s,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function verb(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;c;)try{if(n=1,i&&(a=2&s[0]?i.return:s[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,s[1])).done)return a;switch(i=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return c.label++,{value:s[1],done:!1};case 5:c.label++,i=s[1],s=[0];continue;case 7:s=c.ops.pop(),c.trys.pop();continue;default:if(!(a=c.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){c=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){c.label=s[1];break}if(6===s[0]&&c.label<a[1]){c.label=a[1],a=s;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(s);break}a[2]&&c.ops.pop(),c.trys.pop();continue}s=t.call(e,c)}catch(e){s=[6,e],i=0}finally{n=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};n.__esModule=!0,n.SignalEventManager=void 0;var c=s(e("./peer")),l=console.log,u=function(){function SignalEventManager(e){this.xPeer=e,this.xPeer=e}return SignalEventManager.prototype.roomInfo=function(e){var t=this;if("roomInfo"===e.type){var n=e.payload,i=n.users,a=n.userInfo;this.xPeer.local.nick=a.nick,this.xPeer.local.id=a.id,i.forEach((function(e){t.xPeer.connectPeer(e)})),this.xPeer.emit("roomInfo",i)}},SignalEventManager.prototype.offer=function(e){return i(this,void 0,void 0,(function(){var t,n,i,s;return a(this,(function(a){return e.userInfo&&"offer"===e.type&&(t=e.userInfo,n=t.id,i=t.nick,(s=this.xPeer.findPeer(n))||(s=new c.default(n,i,new RTCPeerConnection(this.xPeer.peerConfig),this.xPeer),this.xPeer.addPeer(s),this.xPeer.pushLocalStreamTo(s)),s.receiveOffer(e)),[2]}))}))},SignalEventManager.prototype.answer=function(e){if("answer"===e.type&&e.userInfo){var t=e.userInfo,n=this.xPeer.findPeer(t.id);null==n||n.receiveAnswer(e.payload)}},SignalEventManager.prototype.icecandidate=function(e){if("icecandidate"===e.type&&e.userInfo){var t=e.userInfo,n=this.xPeer.findPeer(t.id);null==n||n.receiveCandidate(e.payload)}},SignalEventManager.prototype.leave=function(e){if("leave"===e.type){var t=this.xPeer.findPeer(e.payload.id);t&&(t.peerConnection.close(),this.xPeer.local.Peers=this.xPeer.local.Peers.filter((function(e){return e!==t}))),this.xPeer.emit("leave",e.payload)}},SignalEventManager.prototype.join=function(e){},SignalEventManager.prototype.handle=function(){var e=this,t=this;if(!this.xPeer.ws)throw new Error("ws is not defined when handling signal event");this.xPeer.ws.addEventListener("message",(function(e){var n=e.data,i=JSON.parse(n);l("received [".concat(i.type,"]"),i),t[i.type](i)}));var n=setInterval((function(){e.keepAlive()}),59e3);this.xPeer.ws.addEventListener("close",(function(){return clearInterval(n)}))},SignalEventManager.prototype.keepAlive=function(){this.xPeer.signalSend({type:"ping"})},SignalEventManager}();n.SignalEventManager=u},{"./peer":3}],5:[function(e,t,n){"use strict";var i=Object.prototype.hasOwnProperty,a="~";function Events(){}function EE(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function addListener(e,t,n,i,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");var c=new EE(n,i||e,s),l=a?a+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],c]:e._events[l].push(c):(e._events[l]=c,e._eventsCount++),e}function clearEvent(e,t){0==--e._eventsCount?e._events=new Events:delete e._events[t]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(a=!1)),EventEmitter.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)i.call(e,t)&&n.push(a?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},EventEmitter.prototype.listeners=function(e){var t=a?a+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,s=n.length,c=new Array(s);i<s;i++)c[i]=n[i].fn;return c},EventEmitter.prototype.listenerCount=function(e){var t=a?a+e:e,n=this._events[t];return n?n.fn?1:n.length:0},EventEmitter.prototype.emit=function(e,t,n,i,s,c){var l=a?a+e:e;if(!this._events[l])return!1;var u,f,d=this._events[l],p=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),p){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,n),!0;case 4:return d.fn.call(d.context,t,n,i),!0;case 5:return d.fn.call(d.context,t,n,i,s),!0;case 6:return d.fn.call(d.context,t,n,i,s,c),!0}for(f=1,u=new Array(p-1);f<p;f++)u[f-1]=arguments[f];d.fn.apply(d.context,u)}else{var h,v=d.length;for(f=0;f<v;f++)switch(d[f].once&&this.removeListener(e,d[f].fn,void 0,!0),p){case 1:d[f].fn.call(d[f].context);break;case 2:d[f].fn.call(d[f].context,t);break;case 3:d[f].fn.call(d[f].context,t,n);break;case 4:d[f].fn.call(d[f].context,t,n,i);break;default:if(!u)for(h=1,u=new Array(p-1);h<p;h++)u[h-1]=arguments[h];d[f].fn.apply(d[f].context,u)}}return!0},EventEmitter.prototype.on=function(e,t,n){return addListener(this,e,t,n,!1)},EventEmitter.prototype.once=function(e,t,n){return addListener(this,e,t,n,!0)},EventEmitter.prototype.removeListener=function(e,t,n,i){var s=a?a+e:e;if(!this._events[s])return this;if(!t)return clearEvent(this,s),this;var c=this._events[s];if(c.fn)c.fn!==t||i&&!c.once||n&&c.context!==n||clearEvent(this,s);else{for(var l=0,u=[],f=c.length;l<f;l++)(c[l].fn!==t||i&&!c[l].once||n&&c[l].context!==n)&&u.push(c[l]);u.length?this._events[s]=1===u.length?u[0]:u:clearEvent(this,s)}return this},EventEmitter.prototype.removeAllListeners=function(e){var t;return e?(t=a?a+e:e,this._events[t]&&clearEvent(this,t)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=a,EventEmitter.EventEmitter=EventEmitter,void 0!==t&&(t.exports=EventEmitter)},{}]},{},[1])(1)}));
